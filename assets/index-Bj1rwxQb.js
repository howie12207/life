import{d as H,e as P,r as F,A as O,s as V,f as K,c as Q,g as d,j as t,T as U,B as E,u as W,t as Y}from"./index-CyVXoOFO.js";import{t as _,a as B}from"./index-zMglSD1e.js";import{B as R}from"./index-VwafMk3G.js";import{S as J}from"./index-L8M40iiq.js";import{i as X}from"./index-CYepgPze.js";import{B as Z}from"./index-BhuL4YWG.js";import{B as ee}from"./index-BqFVEaWw.js";import{B as te}from"./index-Cngv1zOP.js";import{F as ne,a as se,j as ie}from"./ChevronRightIcon-C1hYs2Ym.js";import"./floating-ui.react-dom-E8g74SFu.js";import"./BaseSkeleton-DvwVxzoM.js";import"./focus-management-DpQ7tlrU.js";import"./bugs-DhYi3BMf.js";import"./field-C2mobymt.js";import"./label-DmBk-9BD.js";import"./use-active-press-CbdhJH1J.js";const re=()=>P({mutationKey:["addDiaryItem"],mutationFn:async s=>await F({method:"post",url:`${O}/diary`,data:s})?(V.success("新增成功"),!0):!1,scope:{id:"addDiaryItem"}}),oe=s=>H({queryKey:["diaryList",s==null?void 0:s.startTime,s==null?void 0:s.endTime],queryFn:async({signal:o})=>{const y=new URLSearchParams;Object.entries(s).forEach(([g,x])=>{x!==void 0&&y.append(g,String(x))});const n=y.toString()?`?${y.toString()}`:"";return await F(`${O}/diary/list${n}`,{signal:o})},staleTime:1e3*60*60,gcTime:1e3*60*60,enabled:s==null?void 0:s.enabled}),z=()=>P({mutationKey:["editDiaryItem"],mutationFn:async s=>await F({method:"patch",url:`${O}/diary?_id=${s._id}`,data:s})?(V.success("編輯成功"),!0):!1,scope:{id:"editDiaryItem"}}),ae=()=>P({mutationKey:["deleteDiaryItem"],mutationFn:async s=>await F({method:"delete",url:`${O}/diary?_id=${s}`})?(V.success("刪除成功"),!0):!1,scope:{id:"deleteDiaryItem"}}),ce=[{name:"提醒",value:"remind"},{name:"健身",value:"workout"},{name:"Out",value:"out"},{name:"無",value:""},{name:"不適",value:"sick"}],le=({isOpen:s,close:o,type:y,data:n,apiGetDiaryList:T})=>{const{enqueueSnackbar:g}=K(),x=Q(),[l,v]=d.useState(new Date),D=d.useRef(null),[b,S]=d.useState(""),[k,w]=d.useState(!1),M=[{validate:X,message:"請輸入內容"}],[a,i]=d.useState(""),[c,e]=d.useState(_(new Date)),{mutateAsync:h,isPending:m}=re(),{mutateAsync:r,isPending:p}=z(),u=async()=>{var j;if(![(j=D.current)==null?void 0:j.validateNow()].every(G=>G))return g("請確認紅框處內容");const N=c.valueOf()-_(c).valueOf(),A={diaryTime:l.valueOf(),content:b,type:a,remindTime:l.valueOf()+N};(y==="add"?await h(A):await r({...A,_id:n==null?void 0:n._id}))&&(x.removeQueries({queryKey:["diaryList"],exact:!1}),T(),C())},{mutateAsync:$,isPending:I}=ae(),L=async()=>{if(!window.confirm(`確定要刪除『${b}』嗎?`)||!(n!=null&&n._id))return;await $(n==null?void 0:n._id)&&(x.removeQueries({queryKey:["diaryList"],exact:!1}),T(),C())};d.useEffect(()=>{!n||!s||(v(_(n==null?void 0:n.diaryTime)),S(n==null?void 0:n.content),i(n==null?void 0:n.type),e(new Date((n==null?void 0:n.remindTime)||(n==null?void 0:n.diaryTime)||_(new Date))))},[s,n]);const C=()=>{o(),v(new Date),S(""),i(""),e(new Date)};return t.jsx(Z,{isOpen:s,close:C,children:t.jsxs("form",{children:[t.jsx("div",{className:"mb-4 text-center text-2xl font-bold text-blue-800",children:`${U[y]||""} ${B(n==null?void 0:n.diaryTime,{onlyDate:!0})}`}),t.jsx(R,{label:"日記日期",value:l,setValue:v,placeholder:"請選擇日記日期"}),t.jsx(te,{className:"mt-5",ref:D,id:"life-content",label:"內容",value:b,setValue:S,isValid:k,setIsValid:w,rules:M,placeholder:"請輸入內容",enter:u,autoFocus:!0}),t.jsx("label",{className:"base-label",children:"類型"}),t.jsx(ee,{radioList:ce,value:a,setValue:i}),a==="remind"&&t.jsx(R,{showTimeSelect:!0,showTimeSelectOnly:!0,dateFormat:"HH:mm",label:"提醒時間",value:c,setValue:e,placeholder:"請選擇提醒時間"}),t.jsxs("div",{className:"mt-8 flex justify-evenly",children:[t.jsx(E,{isLoading:m||p||I,disabled:m||p||I,onClick:u,children:"送出"}),y==="edit"&&t.jsx(E,{type:"danger",isLoading:m||p||I,disabled:m||p||I,onClick:L,children:"刪除"}),t.jsx(E,{type:"info",onClick:C,children:"取消"})]})]})})},me=s=>({0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"})[s],ue=({selectTime:s,now:o,dateList:y,isLoading:n,apiGetDiaryList:T})=>{const g=new Date(s.getFullYear(),s.getMonth(),1).valueOf(),x=new Date(s.getFullYear(),s.getMonth()+1,0).valueOf(),l=Q(),{enqueueSnackbar:v}=K(),D=W(e=>e.accessToken),b=e=>({out:"bg-cyan-100",workout:"bg-red-100",hike:"bg-blue-100",sick:"bg-purple-100",remind:"bg-yellow-100"})[e]||"",{mutateAsync:S}=z(),k=async e=>{var p,u;if(e.preventDefault(),!i._id)return;if(!D){v("請先登入");return}const h=Number((u=(p=e.currentTarget)==null?void 0:p.dataset)==null?void 0:u.timestamp);if(h===i.diaryTime)return;const m={_id:i._id||"",diaryTime:h,content:i.content,type:i.type};i.type==="remind"&&(m.remindTime=h-(i.diaryTime-(i.remindTime||0))),await S(m)&&(l.removeQueries({queryKey:["diaryList"],exact:!1}),T())},[w,M]=d.useState(""),a=e=>{if(!D){v("請先登入");return}c(e),M(e!=null&&e._id?"edit":"add")},[i,c]=d.useState({});return t.jsxs(t.Fragment,{children:[t.jsx("section",{className:"grid h-[calc(100dvh-3.5rem-4rem)] grid-cols-7 overflow-hidden text-xs sm:text-base",children:y.map((e,h)=>{var m;return t.jsxs("div",{className:Y(["border p-1",e.time<g||e.time>x?"bg-gray-400":"bg-gray-300",new Date(o).valueOf()===e.time&&"bg-green-200"]),onClick:()=>a({diaryTime:e.time,content:"",type:"",remindTime:e.time}),onDrop:k,onDragOver:r=>r.preventDefault(),"data-timestamp":e.time,children:[h<7&&t.jsx("div",{className:"text-center",children:me(h)}),t.jsx("div",{className:"text-center",children:B(e.time,{onlyDate:!0}).slice(-2)}),t.jsx(J,{isLoading:n,children:(m=e.content)==null?void 0:m.map((r,p)=>t.jsx("div",{className:Y(["mb-1 cursor-pointer overflow-hidden rounded p-1 text-ellipsis whitespace-nowrap",b(r.type)]),title:r.remindTime?`${B(r.remindTime,{onlyTime:!0})} ${r.content}`:r.content,onClick:u=>{u.stopPropagation(),a({_id:r._id,diaryTime:e.time,content:r.content,type:r.type,remindTime:r.remindTime||e.time})},draggable:!0,onDragStart:()=>c({_id:r._id,diaryTime:e.time,content:r.content,type:r.type,remindTime:r.remindTime}),children:r.content},p))})]},e.time)})}),t.jsx(le,{isOpen:w==="add"||w==="edit",type:w,data:i,close:()=>M(""),apiGetDiaryList:T})]})},Ie=()=>{var k,w,M;const s=_(new Date),[o,y]=d.useState(s),n=()=>{const a=_(new Date);a.valueOf()!==o.valueOf()&&y(a)},T=a=>{const i=new Date(o),c=i.getMonth();a>0?i.setMonth(c+1):i.setMonth(c-1),y(i)},[g,x]=d.useState("all"),[l,v]=d.useState([]);d.useEffect(()=>{v((()=>{const i=o.getFullYear(),c=o.getMonth(),e=new Date(i,c,1),m=new Date(i,c+1,0).getDate(),r=new Date(i,c,0),p=new Date(i,c+1,1),u=[],$=e.getDay(),I=r.getFullYear(),L=r.getMonth();for(let f=$;f>0;f--){const j=new Date(I,L,r.getDate()-f+1).getTime();u.push({time:j,content:[]})}for(let f=1;f<=m;f++){const j=new Date(i,c,f).getTime();u.push({time:j,content:[]})}const q=(u.length>35?42:35)-u.length,N=p.getFullYear(),A=p.getMonth();for(let f=1;f<=q;f++){const j=new Date(N,A,f).getTime();u.push({time:j,content:[]})}return u})())},[o]);const{data:D,isLoading:b,refetch:S}=oe({startTime:(k=l==null?void 0:l[0])==null?void 0:k.time,endTime:(w=l==null?void 0:l[l.length-1])==null?void 0:w.time,enabled:!!((M=l==null?void 0:l[0])!=null&&M.time)});return d.useEffect(()=>{D&&v(a=>{var c;const i=[...a];return i.forEach(e=>e.content=[]),(c=D==null?void 0:D.filter(e=>g==="all"||e.type===g))==null||c.forEach(e=>{var m;const h=i.findIndex(r=>r.time===e.diaryTime);(m=i[h])==null||m.content.push({_id:e._id,diaryTime:e.diaryTime,content:e.content,type:e.type,remindTime:e.remindTime})}),i})},[D,g]),t.jsxs("main",{children:[t.jsxs("div",{className:"relative my-4 flex items-center justify-between px-4",children:[t.jsx(E,{onClick:n,className:"py-1",children:"今天"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx(E,{type:"icon",onClick:()=>T(-1),children:t.jsx(ne,{className:"size-4"})}),t.jsx(R,{value:o,setValue:a=>y(a),showMonthYearPicker:!0,customInput:t.jsx("span",{className:"mx-1 cursor-pointer",children:B(o,{onlyDate:!0}).slice(0,7)})}),t.jsx(E,{type:"icon",onClick:()=>T(1),children:t.jsx(se,{className:"size-4"})})]}),t.jsxs(ie,{value:g,className:"rounded border px-2 py-1",onChange:a=>x(a.target.value),children:[t.jsx("option",{value:"all",children:"全選"}),t.jsx("option",{value:"workout",children:"健身"}),t.jsx("option",{value:"remind",children:"提醒"}),t.jsx("option",{value:"out",children:"Out"}),t.jsx("option",{value:"sick",children:"生病"}),t.jsx("option",{value:"",children:"無"})]})]}),t.jsx(ue,{dateList:l,now:s,selectTime:o,isLoading:b,apiGetDiaryList:S})]})};export{Ie as default};
