import{a as G,b as P,r as B,A as F,s as V,c as Y,u as K,d as h,j as t,B as E,g as H}from"./index-BLArQMGd.js";import{t as _,a as A}from"./format-Btenk6eh.js";import{B as R}from"./index-B_aBI6eW.js";import{S as U}from"./index-Bt9nh2ve.js";import{i as W}from"./validate-DGtL22NN.js";import{T as J}from"./constant-RaoDFmaB.js";import{B as X}from"./index-CgMiA0CP.js";import{B as Z}from"./index-DQXstEZe.js";import{B as ee}from"./index-dU6rSGNN.js";import{F as te,a as ne,j as se}from"./ChevronRightIcon-D5KIuntN.js";import"./floating-ui.react-dom-CUrUag2q.js";import"./BaseSkeleton-Camewocg.js";import"./focus-management-daiDacl4.js";import"./field-HJjlGurK.js";const ie=()=>P({mutationKey:["addDiaryItem"],mutationFn:async s=>{var a;const r=await B({method:"post",url:`${F}/diary`,data:s});return((a=r==null?void 0:r.data)==null?void 0:a.code)===200?(V.success("新增成功"),!0):!1},scope:{id:"addDiaryItem"}}),re=s=>G({queryKey:["diaryList",s==null?void 0:s.startTime,s==null?void 0:s.endTime],queryFn:async({signal:r})=>{var g,v;const a=new URLSearchParams;Object.entries(s).forEach(([c,p])=>{p!==void 0&&a.append(c,String(p))});const n=a.toString()?`?${a.toString()}`:"",m=await B(`${F}/diary/list${n}`,{signal:r});return(g=m==null?void 0:m.data)!=null&&g.data?(v=m==null?void 0:m.data)==null?void 0:v.data:null},staleTime:1e3*60*60,gcTime:1e3*60*60,enabled:s==null?void 0:s.enabled}),Q=()=>P({mutationKey:["editDiaryItem"],mutationFn:async s=>{var a;const r=await B({method:"patch",url:`${F}/diary?_id=${s._id}`,data:s});return((a=r==null?void 0:r.data)==null?void 0:a.code)===200?(V.success("編輯成功"),!0):!1},scope:{id:"editDiaryItem"}}),oe=()=>P({mutationKey:["deleteDiaryItem"],mutationFn:async s=>{var a;const r=await B({method:"delete",url:`${F}/diary?_id=${s}`});return((a=r==null?void 0:r.data)==null?void 0:a.code)===200?(V.success("刪除成功"),!0):!1},scope:{id:"deleteDiaryItem"}}),ae=[{name:"提醒",value:"remind"},{name:"健身",value:"workout"},{name:"Out",value:"out"},{name:"無",value:""},{name:"不適",value:"sick"}],ce=({isOpen:s,close:r,type:a,data:n,apiGetDiaryList:m})=>{const{enqueueSnackbar:g}=Y(),v=K(),[c,p]=h.useState(new Date),T=h.useRef(null),[b,S]=h.useState(""),[k,w]=h.useState(!1),M=[{validate:W,message:"請輸入內容"}],[l,i]=h.useState(""),[u,e]=h.useState(_(new Date)),{mutateAsync:x,isPending:d}=ie(),{mutateAsync:o,isPending:f}=Q(),y=async()=>{var j;if(![(j=T.current)==null?void 0:j.validateNow()].every(z=>z))return g("請確認紅框處內容");const C=u.valueOf()-_(u).valueOf(),$={diaryTime:c.valueOf(),content:b,type:l,remindTime:c.valueOf()+C};(a==="add"?await x($):await o({...$,_id:n==null?void 0:n._id}))&&(v.removeQueries({queryKey:["diaryList"],exact:!1}),m(),N())},{mutateAsync:O,isPending:I}=oe(),L=async()=>{if(!window.confirm(`確定要刪除『${b}』嗎?`)||!(n!=null&&n._id))return;await O(n==null?void 0:n._id)&&(v.removeQueries({queryKey:["diaryList"],exact:!1}),m(),N())};h.useEffect(()=>{!n||!s||(p(_(n==null?void 0:n.diaryTime)),S(n==null?void 0:n.content),i(n==null?void 0:n.type),e(new Date((n==null?void 0:n.remindTime)||(n==null?void 0:n.diaryTime)||_(new Date))))},[s,n]);const N=()=>{r(),p(new Date),S(""),i(""),e(new Date)};return t.jsx(X,{isOpen:s,close:N,children:t.jsxs("form",{children:[t.jsx("div",{className:"mb-4 text-center text-2xl font-bold text-blue-800",children:`${J[a]||""} ${A(n==null?void 0:n.diaryTime,{onlyDate:!0})}`}),t.jsx(R,{label:"日記日期",value:c,setValue:p,placeholder:"請選擇日記日期"}),t.jsx(ee,{className:"mt-5",ref:T,id:"life-content",label:"內容",value:b,setValue:S,isValid:k,setIsValid:w,rules:M,placeholder:"請輸入內容",enter:y}),t.jsx("label",{className:"base-label",children:"類型"}),t.jsx(Z,{radioList:ae,value:l,setValue:i}),l==="remind"&&t.jsx(R,{showTimeSelect:!0,showTimeSelectOnly:!0,dateFormat:"HH:mm",label:"提醒時間",value:u,setValue:e,placeholder:"請選擇提醒時間"}),t.jsxs("div",{className:"mt-8 flex justify-evenly",children:[t.jsx(E,{isLoading:d||f||I,disabled:d||f||I,onClick:y,children:"送出"}),a==="edit"&&t.jsx(E,{type:"danger",isLoading:d||f||I,disabled:d||f||I,onClick:L,children:"刪除"}),t.jsx(E,{type:"info",onClick:N,children:"取消"})]})]})})},le=s=>({0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"})[s],ue=({selectTime:s,now:r,dateList:a,isLoading:n,apiGetDiaryList:m})=>{const g=new Date(s.getFullYear(),s.getMonth(),1).valueOf(),v=new Date(s.getFullYear(),s.getMonth()+1,0).valueOf(),c=K(),{enqueueSnackbar:p}=Y(),T=H(e=>e.accessToken),b=e=>({out:"bg-cyan-100",workout:"bg-red-100",hike:"bg-blue-100",sick:"bg-purple-100",remind:"bg-yellow-100"})[e]||"",{mutateAsync:S}=Q(),k=async e=>{var f,y;if(e.preventDefault(),!i._id)return;if(!T){p("請先登入");return}const x=Number((y=(f=e.currentTarget)==null?void 0:f.dataset)==null?void 0:y.timestamp),d={_id:i._id||"",diaryTime:x,content:i.content,type:i.type};i.type==="remind"&&(d.remindTime=x-(i.diaryTime-(i.remindTime||0))),await S(d)&&(c.removeQueries({queryKey:["diaryList"],exact:!1}),m())},[w,M]=h.useState(""),l=e=>{if(!T){p("請先登入");return}u(e),M(e!=null&&e._id?"edit":"add")},[i,u]=h.useState({});return t.jsxs(t.Fragment,{children:[t.jsx("section",{className:"grid h-[calc(100dvh-3.5rem-4rem)] grid-cols-7 overflow-hidden text-xs sm:text-base",children:a.map((e,x)=>{var d;return t.jsxs("div",{className:`border p-1 ${new Date(r).valueOf()===e.time?"bg-green-200":""} ${e.time<g||e.time>v?"bg-gray-400":"bg-gray-300"}`,onClick:()=>l({diaryTime:e.time,content:"",type:"",remindTime:e.time}),onDrop:k,onDragOver:o=>o.preventDefault(),"data-timestamp":e.time,children:[x<7&&t.jsx("div",{className:"text-center",children:le(x)}),t.jsx("div",{className:"text-center",children:A(e.time,{onlyDate:!0}).slice(-2)}),t.jsx(U,{isLoading:n,children:(d=e.content)==null?void 0:d.map((o,f)=>t.jsx("div",{className:`mb-1 cursor-pointer overflow-hidden rounded p-1 text-ellipsis whitespace-nowrap ${b(o.type)}`,title:`${A(o.remindTime,{onlyTime:!0})} ${o.content}`,onClick:y=>{y.stopPropagation(),l({_id:o._id,diaryTime:e.time,content:o.content,type:o.type,remindTime:o.remindTime||e.time})},draggable:!0,onDragStart:()=>u({_id:o._id,diaryTime:e.time,content:o.content,type:o.type,remindTime:o.remindTime}),children:o.content},f))})]},e.time)})}),t.jsx(ce,{isOpen:w==="add"||w==="edit",type:w,data:i,close:()=>M(""),apiGetDiaryList:m})]})},Se=()=>{var k,w,M;const s=_(new Date),[r,a]=h.useState(s),n=()=>{const l=_(new Date);l.valueOf()!==r.valueOf()&&a(l)},m=l=>{const i=new Date(r),u=i.getMonth();l>0?i.setMonth(u+1):i.setMonth(u-1),a(i)},[g,v]=h.useState("all"),[c,p]=h.useState([]);h.useEffect(()=>{p((()=>{const i=r.getFullYear(),u=r.getMonth(),e=new Date(i,u,1),d=new Date(i,u+1,0).getDate(),o=new Date(i,u,0),f=new Date(i,u+1,1),y=[],O=e.getDay(),I=o.getFullYear(),L=o.getMonth();for(let D=O;D>0;D--){const j=new Date(I,L,o.getDate()-D+1).getTime();y.push({time:j,content:[]})}for(let D=1;D<=d;D++){const j=new Date(i,u,D).getTime();y.push({time:j,content:[]})}const q=(y.length>35?42:35)-y.length,C=f.getFullYear(),$=f.getMonth();for(let D=1;D<=q;D++){const j=new Date(C,$,D).getTime();y.push({time:j,content:[]})}return y})())},[r]);const{data:T,isLoading:b,refetch:S}=re({startTime:(k=c==null?void 0:c[0])==null?void 0:k.time,endTime:(w=c==null?void 0:c[c.length-1])==null?void 0:w.time,enabled:!!((M=c==null?void 0:c[0])!=null&&M.time)});return h.useEffect(()=>{T&&p(l=>{var u;const i=[...l];return i.forEach(e=>e.content=[]),(u=T==null?void 0:T.filter(e=>g==="all"||e.type===g))==null||u.forEach(e=>{var d;const x=i.findIndex(o=>o.time===e.diaryTime);(d=i[x])==null||d.content.push({_id:e._id,diaryTime:e.diaryTime,content:e.content,type:e.type,remindTime:e.remindTime})}),i})},[T,g]),t.jsxs("main",{children:[t.jsxs("div",{className:"relative my-4 flex items-center justify-between px-4",children:[t.jsx(E,{onClick:n,className:"!py-1",children:"今天"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx(E,{type:"icon",onClick:()=>m(-1),children:t.jsx(te,{className:"size-4"})}),t.jsx(R,{value:r,setValue:l=>a(l),showMonthYearPicker:!0,customInput:t.jsx("span",{className:"mx-1 cursor-pointer",children:A(r,{onlyDate:!0}).slice(0,7)})}),t.jsx(E,{type:"icon",onClick:()=>m(1),children:t.jsx(ne,{className:"size-4"})})]}),t.jsxs(se,{value:g,className:"rounded border px-2 py-1",onChange:l=>v(l.target.value),children:[t.jsx("option",{value:"all",children:"全選"}),t.jsx("option",{value:"workout",children:"健身"}),t.jsx("option",{value:"remind",children:"提醒"}),t.jsx("option",{value:"out",children:"Out"}),t.jsx("option",{value:"sick",children:"生病"}),t.jsx("option",{value:"",children:"無"})]})]}),t.jsx(ue,{dateList:c,now:s,selectTime:r,isLoading:b,apiGetDiaryList:S})]})};export{Se as default};
