import{g as Y,c as q,r as m,j as t,T as K,B as E,u as Q,t as V}from"./index-OC3WFbHG.js";import{t as N,f as A}from"./index-DaQTr7AL.js";import{a as z,b as P,c as G,u as H}from"./diary-DrhkNWR3.js";import{B as R}from"./index-eWTtgPmu.js";import{S as W}from"./index-Zz4L8_ed.js";import{i as J}from"./index-CYepgPze.js";import{B as U}from"./index-sFiCn3Ly.js";import{B as X}from"./index-DSGUw015.js";import{B as Z}from"./index-BwJMwPgJ.js";import{F as ee,a as te,j as ne}from"./ChevronRightIcon-CGA40cjX.js";import"./floating-ui.react-dom-Bg_zQiD7.js";import"./BaseSkeleton-DhmxXWWx.js";import"./focus-management-P10Jo0T5.js";import"./bugs-Dkkl8aOa.js";import"./field-C1MpMf7g.js";import"./label-DlAxGvbr.js";import"./use-active-press-Cr-0Sapk.js";const se=[{name:"提醒",value:"remind"},{name:"健身",value:"workout"},{name:"Out",value:"out"},{name:"無",value:""},{name:"不適",value:"sick"}],ie=({isOpen:u,close:d,type:D,data:n,apiGetDiaryList:x})=>{const{enqueueSnackbar:T}=Y(),S=q(),[a,g]=m.useState(new Date),f=m.useRef(null),[j,b]=m.useState(""),[k,v]=m.useState(!1),M=[{validate:J,message:"請輸入內容"}],[r,s]=m.useState(""),[o,e]=m.useState(N(new Date)),{mutateAsync:p,isPending:c}=z(),{mutateAsync:i,isPending:y}=P(),l=async()=>{var w;if(![(w=f.current)==null?void 0:w.validateNow()].every($=>$))return T("請確認紅框處內容");const I=o.valueOf()-N(o).valueOf(),B={diaryTime:a.valueOf(),content:j,type:r,remindTime:a.valueOf()+I};(D==="add"?await p(B):await i({...B,_id:n==null?void 0:n._id}))&&(S.removeQueries({queryKey:["diaryList"],exact:!1}),x(),_())},{mutateAsync:O,isPending:C}=G(),F=async()=>{if(!window.confirm(`確定要刪除『${j}』嗎?`)||!(n!=null&&n._id))return;await O(n==null?void 0:n._id)&&(S.removeQueries({queryKey:["diaryList"],exact:!1}),x(),_())};m.useEffect(()=>{!n||!u||(g(N(n==null?void 0:n.diaryTime)),b(n==null?void 0:n.content),s(n==null?void 0:n.type),e(new Date((n==null?void 0:n.remindTime)||(n==null?void 0:n.diaryTime)||N(new Date))))},[u,n]);const _=()=>{d(),g(new Date),b(""),s(""),e(new Date)};return t.jsx(U,{isOpen:u,close:_,children:t.jsxs("form",{children:[t.jsx("div",{className:"mb-4 text-center text-2xl font-bold text-blue-800",children:`${K[D]||""} ${A(n==null?void 0:n.diaryTime,{onlyDate:!0})}`}),t.jsx(R,{label:"日記日期",value:a,setValue:g,placeholder:"請選擇日記日期"}),t.jsx(Z,{className:"mt-5",ref:f,id:"life-content",label:"內容",value:j,setValue:b,isValid:k,setIsValid:v,rules:M,placeholder:"請輸入內容",enter:l,autoFocus:!0}),t.jsx("label",{className:"base-label",children:"類型"}),t.jsx(X,{radioList:se,value:r,setValue:s}),r==="remind"&&t.jsx(R,{showTimeSelect:!0,showTimeSelectOnly:!0,dateFormat:"HH:mm",label:"提醒時間",value:o,setValue:e,placeholder:"請選擇提醒時間"}),t.jsxs("div",{className:"mt-8 flex justify-evenly",children:[t.jsx(E,{isLoading:c||y||C,disabled:c||y||C,onClick:l,children:"送出"}),D==="edit"&&t.jsx(E,{type:"danger",isLoading:c||y||C,disabled:c||y||C,onClick:F,children:"刪除"}),t.jsx(E,{type:"info",onClick:_,children:"取消"})]})]})})},re=u=>({0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"})[u],oe=({selectTime:u,now:d,dateList:D,isLoading:n,apiGetDiaryList:x})=>{const T=new Date(u.getFullYear(),u.getMonth(),1).valueOf(),S=new Date(u.getFullYear(),u.getMonth()+1,0).valueOf(),a=q(),{enqueueSnackbar:g}=Y(),f=Q(e=>e.accessToken),j=e=>({out:"bg-cyan-100",workout:"bg-red-100",hike:"bg-blue-100",sick:"bg-purple-100",remind:"bg-yellow-100"})[e]||"",{mutateAsync:b}=P(),k=async e=>{var y,l;if(e.preventDefault(),!s._id)return;if(!f){g("請先登入");return}const p=Number((l=(y=e.currentTarget)==null?void 0:y.dataset)==null?void 0:l.timestamp);if(p===s.diaryTime)return;const c={_id:s._id||"",diaryTime:p,content:s.content,type:s.type};s.type==="remind"&&(c.remindTime=p-(s.diaryTime-(s.remindTime||0))),await b(c)&&(a.removeQueries({queryKey:["diaryList"],exact:!1}),x())},[v,M]=m.useState(""),r=e=>{if(!f){g("請先登入");return}o(e),M(e!=null&&e._id?"edit":"add")},[s,o]=m.useState({});return t.jsxs(t.Fragment,{children:[t.jsx("section",{className:"grid h-[calc(100dvh-3.5rem-4rem)] grid-cols-7 overflow-hidden text-xs sm:text-base",children:D.map((e,p)=>{var c;return t.jsxs("div",{className:V(["border p-1",e.time<T||e.time>S?"bg-gray-400":"bg-gray-300",new Date(d).valueOf()===e.time&&"bg-green-200"]),onClick:()=>r({diaryTime:e.time,content:"",type:"",remindTime:e.time}),onDrop:k,onDragOver:i=>i.preventDefault(),"data-timestamp":e.time,children:[p<7&&t.jsx("div",{className:"text-center",children:re(p)}),t.jsx("div",{className:"text-center",children:A(e.time,{onlyDate:!0}).slice(-2)}),t.jsx(W,{isLoading:n,children:(c=e.content)==null?void 0:c.map((i,y)=>t.jsx("div",{className:V(["mb-1 cursor-pointer overflow-hidden rounded p-1 text-ellipsis whitespace-nowrap",j(i.type)]),title:i.remindTime?`${A(i.remindTime,{onlyTime:!0})} ${i.content}`:i.content,onClick:l=>{l.stopPropagation(),r({_id:i._id,diaryTime:e.time,content:i.content,type:i.type,remindTime:i.remindTime||e.time})},draggable:!0,onDragStart:()=>o({_id:i._id,diaryTime:e.time,content:i.content,type:i.type,remindTime:i.remindTime}),children:i.content},y))})]},e.time)})}),t.jsx(ie,{isOpen:v==="add"||v==="edit",type:v,data:s,close:()=>M(""),apiGetDiaryList:x})]})},be=()=>{var k,v,M;const u=N(new Date),[d,D]=m.useState(u),n=()=>{const r=N(new Date);r.valueOf()!==d.valueOf()&&D(r)},x=r=>{const s=new Date(d),o=s.getMonth();r>0?s.setMonth(o+1):s.setMonth(o-1),D(s)},[T,S]=m.useState("all"),[a,g]=m.useState([]);m.useEffect(()=>{g((()=>{const s=d.getFullYear(),o=d.getMonth(),e=new Date(s,o,1),c=new Date(s,o+1,0).getDate(),i=new Date(s,o,0),y=new Date(s,o+1,1),l=[],O=e.getDay(),C=i.getFullYear(),F=i.getMonth();for(let h=O;h>0;h--){const w=new Date(C,F,i.getDate()-h+1).getTime();l.push({time:w,content:[]})}for(let h=1;h<=c;h++){const w=new Date(s,o,h).getTime();l.push({time:w,content:[]})}const L=(l.length>35?42:35)-l.length,I=y.getFullYear(),B=y.getMonth();for(let h=1;h<=L;h++){const w=new Date(I,B,h).getTime();l.push({time:w,content:[]})}return l})())},[d]);const{data:f,isLoading:j,refetch:b}=H({startTime:(k=a==null?void 0:a[0])==null?void 0:k.time,endTime:(v=a==null?void 0:a[a.length-1])==null?void 0:v.time,enabled:!!((M=a==null?void 0:a[0])!=null&&M.time)});return m.useEffect(()=>{f&&g(r=>{var o;const s=[...r];return s.forEach(e=>e.content=[]),(o=f==null?void 0:f.filter(e=>T==="all"||e.type===T))==null||o.forEach(e=>{var c;const p=s.findIndex(i=>i.time===e.diaryTime);(c=s[p])==null||c.content.push({_id:e._id,diaryTime:e.diaryTime,content:e.content,type:e.type,remindTime:e.remindTime})}),s})},[f,T]),t.jsxs("main",{children:[t.jsxs("div",{className:"relative my-4 flex items-center justify-between px-4",children:[t.jsx(E,{onClick:n,className:"py-1",children:"今天"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx(E,{type:"icon",onClick:()=>x(-1),children:t.jsx(ee,{className:"size-4"})}),t.jsx(R,{value:d,setValue:r=>D(r),showMonthYearPicker:!0,customInput:t.jsx("span",{className:"mx-1 cursor-pointer",children:A(d,{onlyDate:!0}).slice(0,7)})}),t.jsx(E,{type:"icon",onClick:()=>x(1),children:t.jsx(te,{className:"size-4"})})]}),t.jsxs(ne,{value:T,className:"rounded border px-2 py-1",onChange:r=>S(r.target.value),children:[t.jsx("option",{value:"all",children:"全選"}),t.jsx("option",{value:"workout",children:"健身"}),t.jsx("option",{value:"remind",children:"提醒"}),t.jsx("option",{value:"out",children:"Out"}),t.jsx("option",{value:"sick",children:"生病"}),t.jsx("option",{value:"",children:"無"})]})]}),t.jsx(oe,{dateList:a,now:u,selectTime:d,isLoading:j,apiGetDiaryList:b})]})};export{be as default};
