import{u as M,a as U,b as $,r as P,A as T,s as R,c as Q,d as n,j as t,B as D,e as J}from"./index-CEMpsM91.js";import{B as A}from"./index-Cbi0vlqJ.js";import{S as W}from"./index-CPzA5FiS.js";import{B as _}from"./index-BEYkbzng.js";import{t as X}from"./format-Btenk6eh.js";import{i as Y,o as Z}from"./validate-C1sTg8Ed.js";import{T as ee}from"./constant-RaoDFmaB.js";import{B as te}from"./index-DA4Sll2E.js";import{B as se}from"./index-ByMrqyZL.js";import{B as ae}from"./index-Blsro8q9.js";import{B as ie}from"./index-DybJ-JXr.js";import"./floating-ui.react-dom-DfQM3LGk.js";import"./focus-management-DHOR56n7.js";import"./PencilSquareIcon-DsY08xBb.js";import"./ChevronRightIcon-CRLkhsfY.js";const ne=()=>$({mutationKey:["addCostItem"],mutationFn:async e=>{var s;const a=await P({method:"post",url:`${T}/cost`,data:e});return((s=a==null?void 0:a.data)==null?void 0:s.code)===200?(R.success("新增成功"),!0):!1},scope:{id:"addCostItem"}}),oe=e=>{const a=M();return U({queryKey:["costList",e==null?void 0:e.page,e==null?void 0:e.size,e==null?void 0:e.itemName,e==null?void 0:e.costStartDate,e==null?void 0:e.costEndDate],queryFn:async({signal:s,queryKey:i})=>{var d,u;const h=a.getQueryData(i);if(h)return h;const x=new URLSearchParams;Object.entries(e).forEach(([o,r])=>{r!==void 0&&r!==-1&&x.append(o,String(r))});const y=x.toString()?`?${x.toString()}`:"",l=await P(`${T}/cost/list${y}`,{signal:s});return(d=l==null?void 0:l.data)!=null&&d.data?(u=l==null?void 0:l.data)==null?void 0:u.data:null},staleTime:1e3*60*60,gcTime:1e3*60*60})},le=()=>$({mutationKey:["editCostItem"],mutationFn:async e=>{var s;const a=await P({method:"patch",url:`${T}/cost?_id=${e._id}`,data:e});return((s=a==null?void 0:a.data)==null?void 0:s.code)===200?(R.success("編輯成功"),!0):!1},scope:{id:"editCostItem"}}),ce=()=>$({mutationKey:["deleteCostItem"],mutationFn:async e=>{var s;const a=await P({method:"delete",url:`${T}/cost?_id=${e}`});return((s=a==null?void 0:a.data)==null?void 0:s.code)===200?(R.success("刪除成功"),!0):!1},scope:{id:"deleteCostItem"}}),re=({isOpen:e,close:a,type:s,data:i,apiGetCostList:h})=>{const{enqueueSnackbar:x}=Q(),y=M(),[l,d]=n.useState(new Date),u=n.useRef(null),[o,r]=n.useState(""),[m,v]=n.useState(!1),C=[{validate:Y,message:"請輸入項目名稱"}],w=n.useRef(null),[g,b]=n.useState(""),[I,L]=n.useState(!1),p=[{validate:Z,message:"請輸入金額"}],[V,c]=n.useState(""),{mutateAsync:B,isPending:f}=ne(),{mutateAsync:S,isPending:N}=le(),j=async()=>{var K,F;if(![(K=u.current)==null?void 0:K.validateNow(),(F=w.current)==null?void 0:F.validateNow()].every(H=>H))return x("請確認紅框處內容");const q={costTime:X(l).valueOf(),itemName:o,price:Number(g),note:V};(s==="add"?await B(q):await S({...q,_id:i==null?void 0:i._id}))&&(y.removeQueries({queryKey:["costList"],exact:!1}),h(),E())},{mutateAsync:z,isPending:k}=ce(),O=async()=>{if(!window.confirm(`確定要刪除『${o}』嗎?`)||!(i!=null&&i._id))return;await z(i==null?void 0:i._id)&&(y.removeQueries({queryKey:["costList"],exact:!1}),h(),E())};n.useEffect(()=>{!i||!e||s==="add"||(d(new Date(i.costDate)),r(i.itemName),b(String(i.price)),c(String(i.note)))},[e,i,s]);const E=()=>{a(),d(new Date),r(""),b(""),c("")};return t.jsx(te,{isOpen:e,close:E,children:t.jsxs("form",{className:"flex max-h-[80dvh] flex-col",children:[t.jsx("div",{className:"mb-4 h-auto text-center text-2xl font-bold text-blue-800",children:`${ee[s]||""}花費項目`}),t.jsxs("section",{className:"overflow-auto",children:[t.jsx(_,{label:"花費日期",value:l,setValue:d,placeholder:"請選擇花費日期"}),t.jsx(A,{className:"mt-5",ref:u,id:"life-itemName",label:"項目名稱",value:o,setValue:r,isValid:m,setIsValid:v,rules:C,placeholder:"請輸入項目名稱",enter:j}),t.jsx(A,{ref:w,id:"life-costDate",label:"花費金額",value:g,setValue:b,isValid:I,setIsValid:L,rules:p,placeholder:"請輸入花費金額",enter:j}),t.jsx(se,{id:"life-note",label:"備註",value:V,setValue:c,placeholder:"請輸入備註"})]}),t.jsxs("div",{className:"mt-8 flex h-auto justify-evenly",children:[t.jsx(D,{isLoading:f||N||k,disabled:f||N||k,onClick:j,children:"送出"}),s==="edit"&&t.jsx(D,{type:"danger",isLoading:f||N||k,disabled:f||N||k,onClick:O,children:"刪除"}),t.jsx(D,{type:"info",onClick:E,children:"取消"})]})]})})},de=[{name:"花費日期",key:"costDate"},{name:"項目名稱",key:"itemName"},{name:"金額",key:"price",type:"dollar"},{name:"備註",key:"note"},{name:"操作",type:"operation",clickType:"edit"}],we=()=>{const{enqueueSnackbar:e}=Q(),[a,s]=n.useState(""),[i,h]=n.useState(null),x=(S,N)=>{var j;s(S),h(c?(j=c.list)==null?void 0:j[N]:null)},y=()=>{u(""),r(void 0),v(void 0)},l=()=>{if(o&&m&&new Date(o)>new Date(m)){e({variant:"error",message:"起始日不能大於結束日"});return}p(1),w({itemName:d||void 0,costStartDate:o==null?void 0:o.valueOf(),costEndDate:m==null?void 0:m.valueOf()})},[d,u]=n.useState(""),[o,r]=n.useState(void 0),[m,v]=n.useState(void 0),[C,w]=n.useState({}),[g,b]=n.useState(1),[I,L]=n.useState(20),p=S=>{J({target:".table"}),b(S)},V=S=>{L(S),p(1)},{data:c,isLoading:B,refetch:f}=oe({page:g-1,size:I,costStartDate:C.costStartDate,costEndDate:C.costEndDate,itemName:C.itemName??void 0});return n.useEffect(()=>{f()},[g,f,I]),t.jsxs("main",{className:"p-4 pb-16",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsx("h2",{className:"page-title",children:"花費清單"}),t.jsx(D,{onClick:()=>s("add"),children:"新增"})]}),t.jsxs(W,{children:[t.jsx(A,{id:"life-itemName",label:"項目名稱",value:d,setValue:u,isValid:!0,setIsValid:()=>({}),placeholder:"請輸入項目名稱",enter:l}),t.jsxs("div",{className:"mb-4 flex items-center gap-4",children:[t.jsx(_,{label:"花費起始日",value:o,setValue:r,placeholder:"請選擇花費日期起始"}),t.jsx(_,{label:"花費結束日",value:m,setValue:v,placeholder:"請選擇花費日期結束",minDate:o})]}),t.jsx(D,{onClick:l,children:"搜尋"}),t.jsx(D,{className:"ml-4",type:"info",onClick:y,children:"重置"})]}),t.jsx(ae,{headList:de,data:c==null?void 0:c.list,className:"mt-4",customClick:x,isLoading:B}),t.jsx(ie,{nowPage:g,size:I,totalPage:Number((c==null?void 0:c.totalPage)??0),changePage:p,changeSize:V,isLoading:B}),t.jsx(re,{isOpen:a==="add"||a==="edit",close:()=>s(""),type:a,data:i,apiGetCostList:f})]})};export{we as default};
