import{a as H,b as P,r as F,A as O,s as V,c as K,u as Q,d as h,j as t,T as U,B as E,e as W,t as Y}from"./index-B_L3cN_n.js";import{t as _,a as B}from"./format-Btenk6eh.js";import{B as R}from"./index-DatchIKP.js";import{S as J}from"./index-BQ38a2vB.js";import{i as X}from"./validate-C1sTg8Ed.js";import{B as Z}from"./index-BAwKlgaM.js";import{B as ee}from"./index-Db4r30i5.js";import{B as te}from"./index-Bd736zeX.js";import{F as ne,a as se,j as ie}from"./ChevronRightIcon-MntUM_Vu.js";import"./floating-ui.react-dom-DxZlNBGc.js";import"./BaseSkeleton-D4CavRdG.js";import"./focus-management-CYr-gYg6.js";import"./bugs-BjHP8vuH.js";import"./field-C63UMvZd.js";import"./label-BuPH-mQZ.js";import"./use-active-press-BMfd9jBN.js";const re=()=>P({mutationKey:["addDiaryItem"],mutationFn:async s=>{var a;const r=await F({method:"post",url:`${O}/diary`,data:s});return((a=r==null?void 0:r.data)==null?void 0:a.code)===200?(V.success("新增成功"),!0):!1},scope:{id:"addDiaryItem"}}),oe=s=>H({queryKey:["diaryList",s==null?void 0:s.startTime,s==null?void 0:s.endTime],queryFn:async({signal:r})=>{var g,v;const a=new URLSearchParams;Object.entries(s).forEach(([c,p])=>{p!==void 0&&a.append(c,String(p))});const n=a.toString()?`?${a.toString()}`:"",m=await F(`${O}/diary/list${n}`,{signal:r});return(g=m==null?void 0:m.data)!=null&&g.data?(v=m==null?void 0:m.data)==null?void 0:v.data:null},staleTime:1e3*60*60,gcTime:1e3*60*60,enabled:s==null?void 0:s.enabled}),z=()=>P({mutationKey:["editDiaryItem"],mutationFn:async s=>{var a;const r=await F({method:"patch",url:`${O}/diary?_id=${s._id}`,data:s});return((a=r==null?void 0:r.data)==null?void 0:a.code)===200?(V.success("編輯成功"),!0):!1},scope:{id:"editDiaryItem"}}),ae=()=>P({mutationKey:["deleteDiaryItem"],mutationFn:async s=>{var a;const r=await F({method:"delete",url:`${O}/diary?_id=${s}`});return((a=r==null?void 0:r.data)==null?void 0:a.code)===200?(V.success("刪除成功"),!0):!1},scope:{id:"deleteDiaryItem"}}),ce=[{name:"提醒",value:"remind"},{name:"健身",value:"workout"},{name:"Out",value:"out"},{name:"無",value:""},{name:"不適",value:"sick"}],le=({isOpen:s,close:r,type:a,data:n,apiGetDiaryList:m})=>{const{enqueueSnackbar:g}=K(),v=Q(),[c,p]=h.useState(new Date),T=h.useRef(null),[b,S]=h.useState(""),[k,w]=h.useState(!1),M=[{validate:X,message:"請輸入內容"}],[l,i]=h.useState(""),[u,e]=h.useState(_(new Date)),{mutateAsync:x,isPending:d}=re(),{mutateAsync:o,isPending:f}=z(),y=async()=>{var j;if(![(j=T.current)==null?void 0:j.validateNow()].every(G=>G))return g("請確認紅框處內容");const N=u.valueOf()-_(u).valueOf(),A={diaryTime:c.valueOf(),content:b,type:l,remindTime:c.valueOf()+N};(a==="add"?await x(A):await o({...A,_id:n==null?void 0:n._id}))&&(v.removeQueries({queryKey:["diaryList"],exact:!1}),m(),C())},{mutateAsync:$,isPending:I}=ae(),L=async()=>{if(!window.confirm(`確定要刪除『${b}』嗎?`)||!(n!=null&&n._id))return;await $(n==null?void 0:n._id)&&(v.removeQueries({queryKey:["diaryList"],exact:!1}),m(),C())};h.useEffect(()=>{!n||!s||(p(_(n==null?void 0:n.diaryTime)),S(n==null?void 0:n.content),i(n==null?void 0:n.type),e(new Date((n==null?void 0:n.remindTime)||(n==null?void 0:n.diaryTime)||_(new Date))))},[s,n]);const C=()=>{r(),p(new Date),S(""),i(""),e(new Date)};return t.jsx(Z,{isOpen:s,close:C,children:t.jsxs("form",{children:[t.jsx("div",{className:"mb-4 text-center text-2xl font-bold text-blue-800",children:`${U[a]||""} ${B(n==null?void 0:n.diaryTime,{onlyDate:!0})}`}),t.jsx(R,{label:"日記日期",value:c,setValue:p,placeholder:"請選擇日記日期"}),t.jsx(te,{className:"mt-5",ref:T,id:"life-content",label:"內容",value:b,setValue:S,isValid:k,setIsValid:w,rules:M,placeholder:"請輸入內容",enter:y,autoFocus:!0}),t.jsx("label",{className:"base-label",children:"類型"}),t.jsx(ee,{radioList:ce,value:l,setValue:i}),l==="remind"&&t.jsx(R,{showTimeSelect:!0,showTimeSelectOnly:!0,dateFormat:"HH:mm",label:"提醒時間",value:u,setValue:e,placeholder:"請選擇提醒時間"}),t.jsxs("div",{className:"mt-8 flex justify-evenly",children:[t.jsx(E,{isLoading:d||f||I,disabled:d||f||I,onClick:y,children:"送出"}),a==="edit"&&t.jsx(E,{type:"danger",isLoading:d||f||I,disabled:d||f||I,onClick:L,children:"刪除"}),t.jsx(E,{type:"info",onClick:C,children:"取消"})]})]})})},ue=s=>({0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"})[s],me=({selectTime:s,now:r,dateList:a,isLoading:n,apiGetDiaryList:m})=>{const g=new Date(s.getFullYear(),s.getMonth(),1).valueOf(),v=new Date(s.getFullYear(),s.getMonth()+1,0).valueOf(),c=Q(),{enqueueSnackbar:p}=K(),T=W(e=>e.accessToken),b=e=>({out:"bg-cyan-100",workout:"bg-red-100",hike:"bg-blue-100",sick:"bg-purple-100",remind:"bg-yellow-100"})[e]||"",{mutateAsync:S}=z(),k=async e=>{var f,y;if(e.preventDefault(),!i._id)return;if(!T){p("請先登入");return}const x=Number((y=(f=e.currentTarget)==null?void 0:f.dataset)==null?void 0:y.timestamp),d={_id:i._id||"",diaryTime:x,content:i.content,type:i.type};i.type==="remind"&&(d.remindTime=x-(i.diaryTime-(i.remindTime||0))),await S(d)&&(c.removeQueries({queryKey:["diaryList"],exact:!1}),m())},[w,M]=h.useState(""),l=e=>{if(!T){p("請先登入");return}u(e),M(e!=null&&e._id?"edit":"add")},[i,u]=h.useState({});return t.jsxs(t.Fragment,{children:[t.jsx("section",{className:"grid h-[calc(100dvh-3.5rem-4rem)] grid-cols-7 overflow-hidden text-xs sm:text-base",children:a.map((e,x)=>{var d;return t.jsxs("div",{className:Y(["border p-1",e.time<g||e.time>v?"bg-gray-400":"bg-gray-300",new Date(r).valueOf()===e.time&&"bg-green-200"]),onClick:()=>l({diaryTime:e.time,content:"",type:"",remindTime:e.time}),onDrop:k,onDragOver:o=>o.preventDefault(),"data-timestamp":e.time,children:[x<7&&t.jsx("div",{className:"text-center",children:ue(x)}),t.jsx("div",{className:"text-center",children:B(e.time,{onlyDate:!0}).slice(-2)}),t.jsx(J,{isLoading:n,children:(d=e.content)==null?void 0:d.map((o,f)=>t.jsx("div",{className:Y(["mb-1 cursor-pointer overflow-hidden rounded p-1 text-ellipsis whitespace-nowrap",b(o.type)]),title:`${B(o.remindTime,{onlyTime:!0})} ${o.content}`,onClick:y=>{y.stopPropagation(),l({_id:o._id,diaryTime:e.time,content:o.content,type:o.type,remindTime:o.remindTime||e.time})},draggable:!0,onDragStart:()=>u({_id:o._id,diaryTime:e.time,content:o.content,type:o.type,remindTime:o.remindTime}),children:o.content},f))})]},e.time)})}),t.jsx(le,{isOpen:w==="add"||w==="edit",type:w,data:i,close:()=>M(""),apiGetDiaryList:m})]})},Ie=()=>{var k,w,M;const s=_(new Date),[r,a]=h.useState(s),n=()=>{const l=_(new Date);l.valueOf()!==r.valueOf()&&a(l)},m=l=>{const i=new Date(r),u=i.getMonth();l>0?i.setMonth(u+1):i.setMonth(u-1),a(i)},[g,v]=h.useState("all"),[c,p]=h.useState([]);h.useEffect(()=>{p((()=>{const i=r.getFullYear(),u=r.getMonth(),e=new Date(i,u,1),d=new Date(i,u+1,0).getDate(),o=new Date(i,u,0),f=new Date(i,u+1,1),y=[],$=e.getDay(),I=o.getFullYear(),L=o.getMonth();for(let D=$;D>0;D--){const j=new Date(I,L,o.getDate()-D+1).getTime();y.push({time:j,content:[]})}for(let D=1;D<=d;D++){const j=new Date(i,u,D).getTime();y.push({time:j,content:[]})}const q=(y.length>35?42:35)-y.length,N=f.getFullYear(),A=f.getMonth();for(let D=1;D<=q;D++){const j=new Date(N,A,D).getTime();y.push({time:j,content:[]})}return y})())},[r]);const{data:T,isLoading:b,refetch:S}=oe({startTime:(k=c==null?void 0:c[0])==null?void 0:k.time,endTime:(w=c==null?void 0:c[c.length-1])==null?void 0:w.time,enabled:!!((M=c==null?void 0:c[0])!=null&&M.time)});return h.useEffect(()=>{T&&p(l=>{var u;const i=[...l];return i.forEach(e=>e.content=[]),(u=T==null?void 0:T.filter(e=>g==="all"||e.type===g))==null||u.forEach(e=>{var d;const x=i.findIndex(o=>o.time===e.diaryTime);(d=i[x])==null||d.content.push({_id:e._id,diaryTime:e.diaryTime,content:e.content,type:e.type,remindTime:e.remindTime})}),i})},[T,g]),t.jsxs("main",{children:[t.jsxs("div",{className:"relative my-4 flex items-center justify-between px-4",children:[t.jsx(E,{onClick:n,className:"py-1",children:"今天"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx(E,{type:"icon",onClick:()=>m(-1),children:t.jsx(ne,{className:"size-4"})}),t.jsx(R,{value:r,setValue:l=>a(l),showMonthYearPicker:!0,customInput:t.jsx("span",{className:"mx-1 cursor-pointer",children:B(r,{onlyDate:!0}).slice(0,7)})}),t.jsx(E,{type:"icon",onClick:()=>m(1),children:t.jsx(se,{className:"size-4"})})]}),t.jsxs(ie,{value:g,className:"rounded border px-2 py-1",onChange:l=>v(l.target.value),children:[t.jsx("option",{value:"all",children:"全選"}),t.jsx("option",{value:"workout",children:"健身"}),t.jsx("option",{value:"remind",children:"提醒"}),t.jsx("option",{value:"out",children:"Out"}),t.jsx("option",{value:"sick",children:"生病"}),t.jsx("option",{value:"",children:"無"})]})]}),t.jsx(me,{dateList:c,now:s,selectTime:r,isLoading:b,apiGetDiaryList:S})]})};export{Ie as default};
