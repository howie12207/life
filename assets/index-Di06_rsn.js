import{u as J,a as se,b as M,r as q,A,s as Q,c as W,d as a,j as e,T as ae,B as S,e as le,f as ne}from"./index-B_L3cN_n.js";import{t as ie,a as re,f as oe}from"./format-Btenk6eh.js";import{B as R}from"./index-Bd736zeX.js";import{S as ce}from"./index-DUYqrrKB.js";import{B as K}from"./index-DatchIKP.js";import{B as de}from"./index-BSiAvAh2.js";import{B as ue}from"./index-CYdQi-Tu.js";import{S as me}from"./index-BQ38a2vB.js";import{i as U,o as fe}from"./validate-C1sTg8Ed.js";import{B as ye}from"./index-BAwKlgaM.js";import{B as he}from"./index-Dzu3_V29.js";import"./bugs-BjHP8vuH.js";import"./use-active-press-BMfd9jBN.js";import"./focus-management-CYr-gYg6.js";import"./use-resolve-button-type-CcdwuV30.js";import"./floating-ui.react-dom-DxZlNBGc.js";import"./PencilSquareIcon-DUUoF6PS.js";import"./ChevronRightIcon-MntUM_Vu.js";import"./label-BuPH-mQZ.js";import"./BaseSkeleton-D4CavRdG.js";const Se=()=>M({mutationKey:["addSalary"],mutationFn:async t=>{var n;const l=await q({method:"post",url:`${A}/salary`,data:t});return((n=l==null?void 0:l.data)==null?void 0:n.code)===200?(Q.success("新增成功"),!0):!1},scope:{id:"addSalary"}}),xe=t=>{const l=J();return se({queryKey:["salaryList",t==null?void 0:t.page,t==null?void 0:t.size,t==null?void 0:t.startTime,t==null?void 0:t.endTime,t==null?void 0:t.place],queryFn:async({signal:n,queryKey:s})=>{var m,f;const d=l.getQueryData(s);if(d)return d;const x=new URLSearchParams;Object.entries(t).forEach(([p,o])=>{o!==void 0&&o!==-1&&x.append(p,String(o))});const D=x.toString()?`?${x.toString()}`:"",r=await q(`${A}/salary/list${D}`,{signal:n});return(m=r==null?void 0:r.data)!=null&&m.data?(f=r==null?void 0:r.data)==null?void 0:f.data:null},staleTime:1e3*60*60,gcTime:1e3*60*60})},pe=()=>M({mutationKey:["editSalary"],mutationFn:async t=>{var n;const l=await q({method:"patch",url:`${A}/salary?_id=${t._id}`,data:t});return((n=l==null?void 0:l.data)==null?void 0:n.code)===200?(Q.success("編輯成功"),!0):!1},scope:{id:"editSalary"}}),ge=()=>M({mutationKey:["deleteSalary"],mutationFn:async t=>{var n;const l=await q({method:"delete",url:`${A}/salary?_id=${t}`});return((n=l==null?void 0:l.data)==null?void 0:n.code)===200?(Q.success("刪除成功"),!0):!1},scope:{id:"deleteSalary"}}),je=({isOpen:t,close:l,type:n,data:s,apiGetData:d})=>{const{enqueueSnackbar:x}=W(),D=J(),[r,m]=a.useState(new Date),f=a.useRef(null),[p,o]=a.useState(""),[u,b]=a.useState(!1),y=[{validate:U,message:"請輸入地方"}],g=a.useRef(null),[v,k]=a.useState(""),[P,B]=a.useState(!1),_=[{validate:U,message:"請輸入內容"}],T=a.useRef(null),[C,j]=a.useState(""),[$,c]=a.useState(!1),N=[{validate:fe,message:"請輸入金額"}],[L,h]=a.useState(""),{mutateAsync:F,isPending:i}=Se(),{mutateAsync:V,isPending:w}=pe(),z=async()=>{var G,O,H;if(![(G=f.current)==null?void 0:G.validateNow(),(O=g.current)==null?void 0:O.validateNow(),(H=T.current)==null?void 0:H.validateNow()].every(te=>te))return x("請確認紅框處內容");const Y={getDate:ie(r).valueOf(),place:p,content:v,dollar:Number(C),remark:L};(n==="add"?await F(Y):await V({...Y,_id:s==null?void 0:s._id}))&&(D.removeQueries({queryKey:["salaryList"],exact:!1}),d(),E())},{mutateAsync:X,isPending:I}=ge(),Z=async()=>{if(!window.confirm(`確定要刪除『${re(s==null?void 0:s.getDate,{onlyDate:!0})}』嗎?`)||!(s!=null&&s._id))return;await X(s==null?void 0:s._id)&&(D.removeQueries({queryKey:["salaryList"],exact:!1}),d(),E())};a.useEffect(()=>{!s||!t||n==="add"||(m(new Date(s.getDate)),o(s.place),k(s.content),j(String(s.dollar)),h(s.remark))},[t,s,n]);const E=()=>{l(),m(new Date),o(""),k(""),j(""),h("")};return e.jsx(ye,{isOpen:t,close:E,children:e.jsxs("form",{className:"flex max-h-[80dvh] flex-col",children:[e.jsx("div",{className:"mb-4 h-auto text-center text-2xl font-bold text-blue-800",children:`${ae[n]||""}薪資`}),e.jsxs("section",{className:"overflow-auto",children:[e.jsx(K,{label:"發薪日期",value:r,setValue:m,placeholder:"請選擇花費日期"}),e.jsx(R,{className:"mt-5",ref:f,id:"life-place",label:"地方",value:p,setValue:o,isValid:u,setIsValid:b,rules:y,placeholder:"請輸入地方"}),e.jsx(R,{ref:g,id:"life-content",label:"內容",value:v,setValue:k,isValid:P,setIsValid:B,rules:_,placeholder:"請輸入內容"}),e.jsx(R,{ref:T,id:"life-dollar",label:"金額",value:C,setValue:j,isValid:$,setIsValid:c,rules:N,placeholder:"請輸入金額",enter:z}),e.jsx(he,{id:"life-note",label:"備註",value:L,setValue:h,placeholder:"請輸入備註"})]}),e.jsxs("div",{className:"mt-8 flex h-auto justify-evenly",children:[e.jsx(S,{isLoading:i||w||I,disabled:i||w||I,onClick:z,children:"送出"}),n==="edit"&&e.jsx(S,{type:"danger",isLoading:i||w||I,disabled:i||w||I,onClick:Z,children:"刪除"}),e.jsx(S,{type:"info",onClick:E,children:"取消"})]})]})})},Ke=()=>{const{enqueueSnackbar:t}=W(),l=le(i=>i.accessToken),n=[{name:"日期",key:"getDate",type:"date"},{name:"地方",key:"place"},{name:"內容",key:"content"},{name:"金額",key:"dollar",type:"dollar"},{name:"備註",key:"remark"},...l?[{name:"操作",type:"operation",clickType:"edit"}]:[]],[s,d]=a.useState(""),[x,D]=a.useState(null),r=(i,V)=>{var w;d(i),D(c?(w=c.list)==null?void 0:w[V]:null)},m=()=>{b(void 0),g(void 0),o("")},f=()=>{if(u&&y&&new Date(u)>new Date(y)){t({variant:"error",message:"起始日不能大於結束日"});return}j(1),k({startTime:u==null?void 0:u.valueOf(),endTime:y==null?void 0:y.valueOf(),place:p})},[p,o]=a.useState(""),[u,b]=a.useState(void 0),[y,g]=a.useState(void 0),[v,k]=a.useState({}),P=i=>{i==="thisYear"?(b(new Date(new Date().getFullYear(),0,1,0,0,0,0)),g(void 0)):i==="lastYear"&&(b(new Date(new Date().getFullYear()-1,0,1,0,0,0,0)),g(new Date(new Date().getFullYear()-1,11,31,23,59,59,999)))},[B,_]=a.useState(1),[T,C]=a.useState(10),j=i=>{ne({target:".table"}),_(i)},$=i=>{C(i),j(1)},{data:c,isLoading:N,refetch:L}=xe({page:B-1,size:T,startTime:v.startTime,endTime:v.endTime,place:v.place??void 0}),h=c==null?void 0:c.list,F=h==null?void 0:h.reduce((i,V)=>i+Number(V.dollar),0);return e.jsxs("main",{className:"p-4 pb-16",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("h2",{className:"page-title",children:"薪資清單"}),l&&e.jsx(S,{onClick:()=>d("add"),children:"新增"})]}),e.jsxs(ce,{children:[e.jsx(R,{id:"life-place",label:"地方",value:p,setValue:o,placeholder:"請輸入地方",enter:f}),e.jsxs("div",{className:"mb-4 flex items-center gap-4",children:[e.jsx(K,{label:"起始日",value:u,setValue:b,placeholder:"請選擇日期起始"}),e.jsx(K,{label:"結束日",value:y,setValue:g,placeholder:"請選擇日期結束",minDate:u})]}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx(S,{type:"warning",onClick:()=>P("thisYear"),children:"今年"}),e.jsx(S,{type:"warning",onClick:()=>P("lastYear"),children:"去年"}),e.jsx(S,{onClick:f,children:"搜尋"}),e.jsx(S,{type:"info",onClick:m,children:"重置"})]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-end",children:["累計：",e.jsx(me,{className:"w-20",isLoading:N,children:oe(F,{type:"dollar"})})]}),e.jsx(de,{headList:n,data:h,className:"mt-4",customClick:r,isLoading:N}),e.jsx(ue,{nowPage:B,size:T,totalPage:Number((c==null?void 0:c.totalPage)??0),changePage:j,changeSize:$,isLoading:N}),e.jsx(je,{isOpen:s==="add"||s==="edit",close:()=>d(""),type:s,data:x,apiGetData:L})]})};export{Ke as default};
