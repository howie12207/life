import{c as Q,d as U,e as R,r as T,A as E,s as F,f as z,g as i,j as t,T as J,B as p,u as W,h as X}from"./index-DDypmYjo.js";import{B as _}from"./index-Dz8zM4Uw.js";import{S as Y}from"./index-BV463Ogs.js";import{B as $}from"./index-C2aQDjq0.js";import{B as Z}from"./index-DVgk-sXN.js";import{B as ee}from"./index-B0YOOcok.js";import{t as te}from"./index-CkZiW-Ay.js";import{i as se,o as ae}from"./index-CYepgPze.js";import{B as oe}from"./index-B0D6fUry.js";import{B as ie}from"./index-DmQ0_fQS.js";import"./bugs-B2fo5EXd.js";import"./use-active-press-BDL4cN4v.js";import"./focus-management-Df9FbtWO.js";import"./use-resolve-button-type-Cn49qi3l.js";import"./floating-ui.react-dom-CVX-LADh.js";import"./PencilSquareIcon-C5fPVU_r.js";import"./ChevronRightIcon-BJnIeRQY.js";import"./label-B4nrvT7a.js";const ne=()=>R({mutationKey:["addCostItem"],mutationFn:async e=>{var o;const a=await T({method:"post",url:`${E}/cost`,data:e});return((o=a==null?void 0:a.data)==null?void 0:o.code)===200?(F.success("新增成功"),!0):!1},scope:{id:"addCostItem"}}),le=e=>{const a=Q();return U({queryKey:["costList",e==null?void 0:e.page,e==null?void 0:e.size,e==null?void 0:e.itemName,e==null?void 0:e.costStartDate,e==null?void 0:e.costEndDate],queryFn:async({signal:o,queryKey:s})=>{var m,f;const u=a.getQueryData(s);if(u)return u;const S=new URLSearchParams;Object.entries(e).forEach(([h,r])=>{r!==void 0&&r!==-1&&S.append(h,String(r))});const N=S.toString()?`?${S.toString()}`:"",l=await T(`${E}/cost/list${N}`,{signal:o});return(m=l==null?void 0:l.data)!=null&&m.data?(f=l==null?void 0:l.data)==null?void 0:f.data:null},staleTime:1e3*60*60,gcTime:1e3*60*60})},ce=()=>R({mutationKey:["editCostItem"],mutationFn:async e=>{var o;const a=await T({method:"patch",url:`${E}/cost?_id=${e._id}`,data:e});return((o=a==null?void 0:a.data)==null?void 0:o.code)===200?(F.success("編輯成功"),!0):!1},scope:{id:"editCostItem"}}),re=()=>R({mutationKey:["deleteCostItem"],mutationFn:async e=>{var o;const a=await T({method:"delete",url:`${E}/cost?_id=${e}`});return((o=a==null?void 0:a.data)==null?void 0:o.code)===200?(F.success("刪除成功"),!0):!1},scope:{id:"deleteCostItem"}}),ue=({isOpen:e,close:a,type:o,data:s,apiGetCostList:u})=>{const{enqueueSnackbar:S}=z(),N=Q(),[l,m]=i.useState(new Date),f=i.useRef(null),[h,r]=i.useState(""),[d,b]=i.useState(!1),x=[{validate:se,message:"請輸入項目名稱"}],C=i.useRef(null),[j,I]=i.useState(""),[v,P]=i.useState(!1),w=[{validate:ae,message:"請輸入金額"}],[k,y]=i.useState(""),{mutateAsync:L,isPending:n}=ne(),{mutateAsync:B,isPending:D}=ce(),c=async()=>{var K,M;if(![(K=f.current)==null?void 0:K.validateNow(),(M=C.current)==null?void 0:M.validateNow()].every(H=>H))return S("請確認紅框處內容");const A={costTime:te(l).valueOf(),itemName:h,price:Number(j),note:k};(o==="add"?await L(A):await B({...A,_id:s==null?void 0:s._id}))&&(N.removeQueries({queryKey:["costList"],exact:!1}),u(),V())},{mutateAsync:q,isPending:g}=re(),O=async()=>{if(!window.confirm(`確定要刪除『${h}』嗎?`)||!(s!=null&&s._id))return;await q(s==null?void 0:s._id)&&(N.removeQueries({queryKey:["costList"],exact:!1}),u(),V())};i.useEffect(()=>{!s||!e||o==="add"||(m(new Date(s.costDate)),r(s.itemName),I(String(s.price)),y(String(s.note)))},[e,s,o]);const V=()=>{a(),m(new Date),r(""),I(""),y("")};return t.jsx(oe,{isOpen:e,close:V,children:t.jsxs("form",{className:"flex max-h-[80dvh] flex-col",children:[t.jsx("div",{className:"mb-4 h-auto text-center text-2xl font-bold text-blue-800",children:`${J[o]||""}花費項目`}),t.jsxs("section",{className:"overflow-auto",children:[t.jsx($,{label:"花費日期",value:l,setValue:m,placeholder:"請選擇花費日期"}),t.jsx(_,{className:"mt-5",ref:f,id:"life-itemName",label:"項目名稱",value:h,setValue:r,isValid:d,setIsValid:b,rules:x,placeholder:"請輸入項目名稱",enter:c,autoFocus:!0}),t.jsx(_,{ref:C,id:"life-costDate",label:"花費金額",value:j,setValue:I,isValid:v,setIsValid:P,rules:w,placeholder:"請輸入花費金額",enter:c}),t.jsx(ie,{id:"life-note",label:"備註",value:k,setValue:y,placeholder:"請輸入備註"})]}),t.jsxs("div",{className:"mt-8 flex h-auto justify-evenly",children:[t.jsx(p,{isLoading:n||D||g,disabled:n||D||g,onClick:c,children:"送出"}),o==="edit"&&t.jsx(p,{type:"danger",isLoading:n||D||g,disabled:n||D||g,onClick:O,children:"刪除"}),t.jsx(p,{type:"info",onClick:V,children:"取消"})]})]})})},Ve=()=>{const{enqueueSnackbar:e}=z(),a=W(c=>c.accessToken),o=[{name:"花費日期",key:"costDate"},{name:"項目名稱",key:"itemName"},{name:"金額",key:"price",type:"dollar"},{name:"備註",key:"note"},...a?[{name:"操作",type:"operation",clickType:"edit"}]:[]],[s,u]=i.useState(""),[S,N]=i.useState(null),l=(c,q)=>{var g;u(c),N(n?(g=n.list)==null?void 0:g[q]:null)},m=()=>{r(""),b(void 0),C(void 0)},f=()=>{if(d&&x&&new Date(d)>new Date(x)){e({variant:"error",message:"起始日不能大於結束日"});return}y(1),I({itemName:h||void 0,costStartDate:d==null?void 0:d.valueOf(),costEndDate:x==null?void 0:x.valueOf()})},[h,r]=i.useState(""),[d,b]=i.useState(void 0),[x,C]=i.useState(void 0),[j,I]=i.useState({}),[v,P]=i.useState(1),[w,k]=i.useState(20),y=c=>{X({target:".table"}),P(c)},L=c=>{k(c),y(1)},{data:n,isLoading:B,refetch:D}=le({page:v-1,size:w,costStartDate:j.costStartDate,costEndDate:j.costEndDate,itemName:j.itemName??void 0});return t.jsxs("main",{className:"p-4 pb-16",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsx("h2",{className:"page-title",children:"花費清單"}),a&&t.jsx(p,{onClick:()=>u("add"),children:"新增"})]}),t.jsxs(Y,{children:[t.jsx(_,{id:"life-itemName",label:"項目名稱",value:h,setValue:r,isValid:!0,setIsValid:()=>({}),placeholder:"請輸入項目名稱",enter:f}),t.jsxs("div",{className:"mb-4 flex items-center gap-4",children:[t.jsx($,{label:"花費起始日",value:d,setValue:b,placeholder:"請選擇花費日期起始"}),t.jsx($,{label:"花費結束日",value:x,setValue:C,placeholder:"請選擇花費日期結束",minDate:d})]}),t.jsx(p,{onClick:f,children:"搜尋"}),t.jsx(p,{className:"ml-4",type:"info",onClick:m,children:"重置"})]}),t.jsx(Z,{headList:o,data:n==null?void 0:n.list,className:"mt-4",customClick:l,isLoading:B}),t.jsx(ee,{nowPage:v,size:w,totalPage:Number((n==null?void 0:n.totalPage)??0),changePage:y,changeSize:L,isLoading:B}),t.jsx(ue,{isOpen:s==="add"||s==="edit",close:()=>u(""),type:s,data:S,apiGetCostList:D})]})};export{Ve as default};
