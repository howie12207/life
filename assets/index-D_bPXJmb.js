import{c as Q,d as U,e as R,f as T,A as E,s as F,g as z,r as a,j as t,T as J,B as D,u as W,h as X}from"./index-M_qKJs4h.js";import{B as _}from"./index-BZx3Mpcp.js";import{S as Y}from"./index-DObpVWhC.js";import{B as $}from"./index-Co2GMs6Q.js";import{B as Z}from"./index-BOE2mYn0.js";import{B as ee}from"./index-CxtE0pBx.js";import{t as te}from"./index-Dw_9iyLG.js";import{i as se,o as ae}from"./index-CYepgPze.js";import{B as ie}from"./index-JAylExdX.js";import{B as oe}from"./index-DiK6wgth.js";import"./bugs-CQzQiWS_.js";import"./use-active-press-CHczXA7a.js";import"./focus-management-DZBLReu2.js";import"./use-resolve-button-type-V8OXcgow.js";import"./floating-ui.react-dom-BHUCWtY_.js";import"./PencilSquareIcon-BOhs7HKF.js";import"./ChevronRightIcon-CAmBCP8i.js";import"./label-Bavwe23N.js";const ne=()=>R({mutationKey:["addCostItem"],mutationFn:async e=>await T({method:"post",url:`${E}/cost`,data:e})?(F.success("新增成功"),!0):!1,scope:{id:"addCostItem"}}),le=e=>{const n=Q();return U({queryKey:["costList",e==null?void 0:e.page,e==null?void 0:e.size,e==null?void 0:e.itemName,e==null?void 0:e.costStartDate,e==null?void 0:e.costEndDate],queryFn:async({signal:l,queryKey:s})=>{const c=n.getQueryData(s);if(c)return c;const m=new URLSearchParams;Object.entries(e).forEach(([f,r])=>{r!==void 0&&r!==-1&&m.append(f,String(r))});const S=m.toString()?`?${m.toString()}`:"";return await T(`${E}/cost/list${S}`,{signal:l})},staleTime:1e3*60*60,gcTime:1e3*60*60})},ce=()=>R({mutationKey:["editCostItem"],mutationFn:async e=>await T({method:"patch",url:`${E}/cost?_id=${e._id}`,data:e})?(F.success("編輯成功"),!0):!1,scope:{id:"editCostItem"}}),re=()=>R({mutationKey:["deleteCostItem"],mutationFn:async e=>await T({method:"delete",url:`${E}/cost?_id=${e}`})?(F.success("刪除成功"),!0):!1,scope:{id:"deleteCostItem"}}),ue=({isOpen:e,close:n,type:l,data:s,apiGetCostList:c})=>{const{enqueueSnackbar:m}=z(),S=Q(),[p,f]=a.useState(new Date),r=a.useRef(null),[y,g]=a.useState(""),[u,I]=a.useState(!1),d=[{validate:se,message:"請輸入項目名稱"}],C=a.useRef(null),[N,b]=a.useState(""),[v,P]=a.useState(!1),w=[{validate:ae,message:"請輸入金額"}],[k,h]=a.useState(""),{mutateAsync:L,isPending:i}=ne(),{mutateAsync:B,isPending:j}=ce(),o=async()=>{var K,M;if(![(K=r.current)==null?void 0:K.validateNow(),(M=C.current)==null?void 0:M.validateNow()].every(H=>H))return m("請確認紅框處內容");const A={costTime:te(p).valueOf(),itemName:y,price:Number(N),note:k};(l==="add"?await L(A):await B({...A,_id:s==null?void 0:s._id}))&&(S.removeQueries({queryKey:["costList"],exact:!1}),c(),V())},{mutateAsync:q,isPending:x}=re(),O=async()=>{if(!window.confirm(`確定要刪除『${y}』嗎?`)||!(s!=null&&s._id))return;await q(s==null?void 0:s._id)&&(S.removeQueries({queryKey:["costList"],exact:!1}),c(),V())};a.useEffect(()=>{!s||!e||l==="add"||(f(new Date(s.costDate)),g(s.itemName),b(String(s.price)),h(String(s.note)))},[e,s,l]);const V=()=>{n(),f(new Date),g(""),b(""),h("")};return t.jsx(ie,{isOpen:e,close:V,children:t.jsxs("form",{className:"flex max-h-[80dvh] flex-col",children:[t.jsx("div",{className:"mb-4 h-auto text-center text-2xl font-bold text-blue-800",children:`${J[l]||""}花費項目`}),t.jsxs("section",{className:"overflow-auto",children:[t.jsx($,{label:"花費日期",value:p,setValue:f,placeholder:"請選擇花費日期"}),t.jsx(_,{className:"mt-5",ref:r,id:"life-itemName",label:"項目名稱",value:y,setValue:g,isValid:u,setIsValid:I,rules:d,placeholder:"請輸入項目名稱",enter:o,autoFocus:!0}),t.jsx(_,{ref:C,id:"life-costDate",label:"花費金額",value:N,setValue:b,isValid:v,setIsValid:P,rules:w,placeholder:"請輸入花費金額",enter:o}),t.jsx(oe,{id:"life-note",label:"備註",value:k,setValue:h,placeholder:"請輸入備註"})]}),t.jsxs("div",{className:"mt-8 flex h-auto justify-evenly",children:[t.jsx(D,{isLoading:i||j||x,disabled:i||j||x,onClick:o,children:"送出"}),l==="edit"&&t.jsx(D,{type:"danger",isLoading:i||j||x,disabled:i||j||x,onClick:O,children:"刪除"}),t.jsx(D,{type:"info",onClick:V,children:"取消"})]})]})})},Ve=()=>{const{enqueueSnackbar:e}=z(),n=W(o=>o.accessToken),l=[{name:"花費日期",key:"costDate"},{name:"項目名稱",key:"itemName"},{name:"金額",key:"price",type:"dollar"},{name:"備註",key:"note"},...n?[{name:"操作",type:"operation",clickType:"edit"}]:[]],[s,c]=a.useState(""),[m,S]=a.useState(null),p=(o,q)=>{var x;c(o),S(i?(x=i.list)==null?void 0:x[q]:null)},f=()=>{g(""),I(void 0),C(void 0)},r=()=>{if(u&&d&&new Date(u)>new Date(d)){e({variant:"error",message:"起始日不能大於結束日"});return}h(1),b({itemName:y||void 0,costStartDate:u==null?void 0:u.valueOf(),costEndDate:d==null?void 0:d.valueOf()})},[y,g]=a.useState(""),[u,I]=a.useState(void 0),[d,C]=a.useState(void 0),[N,b]=a.useState({}),[v,P]=a.useState(1),[w,k]=a.useState(20),h=o=>{X({target:".base-table"}),P(o)},L=o=>{k(o),h(1)},{data:i,isLoading:B,refetch:j}=le({page:v-1,size:w,costStartDate:N.costStartDate,costEndDate:N.costEndDate,itemName:N.itemName??void 0});return t.jsxs("main",{className:"p-4 pb-16",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsx("h2",{className:"page-title",children:"花費清單"}),n&&t.jsx(D,{onClick:()=>c("add"),children:"新增"})]}),t.jsxs(Y,{children:[t.jsx(_,{id:"life-itemName",label:"項目名稱",value:y,setValue:g,isValid:!0,setIsValid:()=>({}),placeholder:"請輸入項目名稱",enter:r}),t.jsxs("div",{className:"mb-4 flex items-center gap-4",children:[t.jsx($,{label:"花費起始日",value:u,setValue:I,placeholder:"請選擇花費日期起始"}),t.jsx($,{label:"花費結束日",value:d,setValue:C,placeholder:"請選擇花費日期結束",minDate:u})]}),t.jsx(D,{onClick:r,children:"搜尋"}),t.jsx(D,{className:"ml-4",type:"info",onClick:f,children:"重置"})]}),t.jsx(Z,{headList:l,data:i==null?void 0:i.list,className:"mt-4",customClick:p,isLoading:B}),t.jsx(ee,{nowPage:v,size:w,totalPage:Number((i==null?void 0:i.totalPage)??0),changePage:h,changeSize:L,isLoading:B}),t.jsx(ue,{isOpen:s==="add"||s==="edit",close:()=>c(""),type:s,data:m,apiGetCostList:j})]})};export{Ve as default};
