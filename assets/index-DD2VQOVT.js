import{u as Q,a as U,b as R,r as E,A as T,s as K,c as z,d as o,j as t,T as J,B as p,e as W,f as X}from"./index-BsT9PFH1.js";import{B as _}from"./index-D8YX5iPM.js";import{S as Y}from"./index-rClmLzGq.js";import{B as $}from"./index-DBc3Usas.js";import{B as Z}from"./index-Bw_07ed7.js";import{B as ee}from"./index-C0FuhJtc.js";import{t as te}from"./format-Btenk6eh.js";import{i as se,o as ae}from"./validate-C1sTg8Ed.js";import{B as ie}from"./index-ByU6m4XI.js";import{B as oe}from"./index-DVCoHyIL.js";import"./bugs-_ZnruFTO.js";import"./use-active-press-DEeDwIsb.js";import"./focus-management-Bxz331r8.js";import"./use-resolve-button-type-CXQnlQmL.js";import"./floating-ui.react-dom-Bu5kYqTR.js";import"./PencilSquareIcon-BHWd3W6i.js";import"./ChevronRightIcon-COE9f1A9.js";import"./label-Dle3GftA.js";const ne=()=>R({mutationKey:["addCostItem"],mutationFn:async e=>{var i;const a=await E({method:"post",url:`${T}/cost`,data:e});return((i=a==null?void 0:a.data)==null?void 0:i.code)===200?(K.success("新增成功"),!0):!1},scope:{id:"addCostItem"}}),le=e=>{const a=Q();return U({queryKey:["costList",e==null?void 0:e.page,e==null?void 0:e.size,e==null?void 0:e.itemName,e==null?void 0:e.costStartDate,e==null?void 0:e.costEndDate],queryFn:async({signal:i,queryKey:s})=>{var m,f;const d=a.getQueryData(s);if(d)return d;const y=new URLSearchParams;Object.entries(e).forEach(([h,r])=>{r!==void 0&&r!==-1&&y.append(h,String(r))});const j=y.toString()?`?${y.toString()}`:"",l=await E(`${T}/cost/list${j}`,{signal:i});return(m=l==null?void 0:l.data)!=null&&m.data?(f=l==null?void 0:l.data)==null?void 0:f.data:null},staleTime:1e3*60*60,gcTime:1e3*60*60})},ce=()=>R({mutationKey:["editCostItem"],mutationFn:async e=>{var i;const a=await E({method:"patch",url:`${T}/cost?_id=${e._id}`,data:e});return((i=a==null?void 0:a.data)==null?void 0:i.code)===200?(K.success("編輯成功"),!0):!1},scope:{id:"editCostItem"}}),re=()=>R({mutationKey:["deleteCostItem"],mutationFn:async e=>{var i;const a=await E({method:"delete",url:`${T}/cost?_id=${e}`});return((i=a==null?void 0:a.data)==null?void 0:i.code)===200?(K.success("刪除成功"),!0):!1},scope:{id:"deleteCostItem"}}),de=({isOpen:e,close:a,type:i,data:s,apiGetCostList:d})=>{const{enqueueSnackbar:y}=z(),j=Q(),[l,m]=o.useState(new Date),f=o.useRef(null),[h,r]=o.useState(""),[u,w]=o.useState(!1),x=[{validate:se,message:"請輸入項目名稱"}],C=o.useRef(null),[D,b]=o.useState(""),[I,P]=o.useState(!1),v=[{validate:ae,message:"請輸入金額"}],[k,g]=o.useState(""),{mutateAsync:L,isPending:n}=ne(),{mutateAsync:B,isPending:S}=ce(),c=async()=>{var F,M;if(![(F=f.current)==null?void 0:F.validateNow(),(M=C.current)==null?void 0:M.validateNow()].every(H=>H))return y("請確認紅框處內容");const A={costTime:te(l).valueOf(),itemName:h,price:Number(D),note:k};(i==="add"?await L(A):await B({...A,_id:s==null?void 0:s._id}))&&(j.removeQueries({queryKey:["costList"],exact:!1}),d(),V())},{mutateAsync:q,isPending:N}=re(),O=async()=>{if(!window.confirm(`確定要刪除『${h}』嗎?`)||!(s!=null&&s._id))return;await q(s==null?void 0:s._id)&&(j.removeQueries({queryKey:["costList"],exact:!1}),d(),V())};o.useEffect(()=>{!s||!e||i==="add"||(m(new Date(s.costDate)),r(s.itemName),b(String(s.price)),g(String(s.note)))},[e,s,i]);const V=()=>{a(),m(new Date),r(""),b(""),g("")};return t.jsx(ie,{isOpen:e,close:V,children:t.jsxs("form",{className:"flex max-h-[80dvh] flex-col",children:[t.jsx("div",{className:"mb-4 h-auto text-center text-2xl font-bold text-blue-800",children:`${J[i]||""}花費項目`}),t.jsxs("section",{className:"overflow-auto",children:[t.jsx($,{label:"花費日期",value:l,setValue:m,placeholder:"請選擇花費日期"}),t.jsx(_,{className:"mt-5",ref:f,id:"life-itemName",label:"項目名稱",value:h,setValue:r,isValid:u,setIsValid:w,rules:x,placeholder:"請輸入項目名稱",enter:c}),t.jsx(_,{ref:C,id:"life-costDate",label:"花費金額",value:D,setValue:b,isValid:I,setIsValid:P,rules:v,placeholder:"請輸入花費金額",enter:c}),t.jsx(oe,{id:"life-note",label:"備註",value:k,setValue:g,placeholder:"請輸入備註"})]}),t.jsxs("div",{className:"mt-8 flex h-auto justify-evenly",children:[t.jsx(p,{isLoading:n||S||N,disabled:n||S||N,onClick:c,children:"送出"}),i==="edit"&&t.jsx(p,{type:"danger",isLoading:n||S||N,disabled:n||S||N,onClick:O,children:"刪除"}),t.jsx(p,{type:"info",onClick:V,children:"取消"})]})]})})},Ve=()=>{const{enqueueSnackbar:e}=z(),a=W(c=>c.accessToken),i=[{name:"花費日期",key:"costDate"},{name:"項目名稱",key:"itemName"},{name:"金額",key:"price",type:"dollar"},{name:"備註",key:"note"},...a?[{name:"操作",type:"operation",clickType:"edit"}]:[]],[s,d]=o.useState(""),[y,j]=o.useState(null),l=(c,q)=>{var N;d(c),j(n?(N=n.list)==null?void 0:N[q]:null)},m=()=>{r(""),w(void 0),C(void 0)},f=()=>{if(u&&x&&new Date(u)>new Date(x)){e({variant:"error",message:"起始日不能大於結束日"});return}g(1),b({itemName:h||void 0,costStartDate:u==null?void 0:u.valueOf(),costEndDate:x==null?void 0:x.valueOf()})},[h,r]=o.useState(""),[u,w]=o.useState(void 0),[x,C]=o.useState(void 0),[D,b]=o.useState({}),[I,P]=o.useState(1),[v,k]=o.useState(20),g=c=>{X({target:".table"}),P(c)},L=c=>{k(c),g(1)},{data:n,isLoading:B,refetch:S}=le({page:I-1,size:v,costStartDate:D.costStartDate,costEndDate:D.costEndDate,itemName:D.itemName??void 0});return o.useEffect(()=>{S()},[I,S,v]),t.jsxs("main",{className:"p-4 pb-16",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsx("h2",{className:"page-title",children:"花費清單"}),a&&t.jsx(p,{onClick:()=>d("add"),children:"新增"})]}),t.jsxs(Y,{children:[t.jsx(_,{id:"life-itemName",label:"項目名稱",value:h,setValue:r,isValid:!0,setIsValid:()=>({}),placeholder:"請輸入項目名稱",enter:f}),t.jsxs("div",{className:"mb-4 flex items-center gap-4",children:[t.jsx($,{label:"花費起始日",value:u,setValue:w,placeholder:"請選擇花費日期起始"}),t.jsx($,{label:"花費結束日",value:x,setValue:C,placeholder:"請選擇花費日期結束",minDate:u})]}),t.jsx(p,{onClick:f,children:"搜尋"}),t.jsx(p,{className:"ml-4",type:"info",onClick:m,children:"重置"})]}),t.jsx(Z,{headList:i,data:n==null?void 0:n.list,className:"mt-4",customClick:l,isLoading:B}),t.jsx(ee,{nowPage:I,size:v,totalPage:Number((n==null?void 0:n.totalPage)??0),changePage:g,changeSize:L,isLoading:B}),t.jsx(de,{isOpen:s==="add"||s==="edit",close:()=>d(""),type:s,data:y,apiGetCostList:S})]})};export{Ve as default};
